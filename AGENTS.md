# Codex Cloud — Operating Guide (Core)

> Ядро правил. Подробные плейбуки и команды — в `.memory/CONTEXT.md`.
> Политика автономности и пороги — `.memory/AUTONOMY.md`.
> Миссия/контекст/ADR/таски/прогресс — в `.memory/*`. Контракты — в `contracts/*`.

---

## 0) Обязательный старт
1. Спроси пользователя: **"Степень автономности (0,1,2)?"**  
   - **2** — полная автономия.  
   - **1** — согласовывай, если срабатывают пороги из `.memory/AUTONOMY.md`.  
   - **0** — согласовывай почти всё (кроме мелких правок/простых тестов/безопасных проверок).  
2. Если ответ не получен — **остановись** (см. CONSENT_WINDOW в `.memory/AUTONOMY.md`).

## 1) Must-Read перед задачей
Последовательность чтения:
1) `.memory/MISSION.md` → зачем/ценность/scope.  
2) `.memory/CONTEXT.md` → окружения, стек, команды, quality policy, Deprecation.  
3) `.memory/TASKS.md` → активные задачи (запомни id/owner).  
4) `.memory/DECISIONS.md` → ADR цепочка (учти `status/supersedes`).  
5) `contracts/*` + `contracts/VERSION.json` → версия API и изменения.  
6) `.memory/USECASES.md` → сценарии + acceptance criteria.  
7) `.memory/INDEX.yaml` → быстрый контроль актуальности артефактов.

## 2) LOCK и рабочий журнал
- Перед изменениями создай **`.memory/LOCK.<taskId>`**. Если LOCK чужой — **не** редактируй канбан/прогресс/ADR; пиши **только** в `WORKLOG.md`.  
- До checkpoint все шаги записывай в `.memory/WORKLOG.md` (черновик).  
- После прохождения checkpoint (см. ниже) — синхронизируй `.memory/TASKS.md`/`.memory/PROGRESS.md`, при необходимости — `.memory/DECISIONS.md`.

## 3) Канонический процесс (SDD)
**Contracts → Tests → Code → ADR → Progress**
1) Любые изменения поведения/публичных интерфейсов — **сначала** `contracts/*`.  
2) Добавь/обнови unit + contract-тесты; прогон pre-commit чек-листа (см. CONTEXT).  
3) Внеси минимально достаточные изменения кода.  
4) Если принято архитектурное решение — ADR-запись в `.memory/DECISIONS.md`.  
5) Обнови прогресс (после checkpoint): `.memory/PROGRESS.md` (1 строка), статус в `.memory/TASKS.md`.

## 4) Checkpoints (минимум)
Считается пройденным, если одновременно:
- `contracts/*` валидны и версия в `contracts/VERSION.json` обновлена по правилам SemVer (MAJOR/MINOR/PATCH);  
- unit + contract тесты зелёные;  
- дельта изменений ≤ порога или подтверждена пользователем (см. AUTONOMY);  
- ADR (если нужно) создан/обновлён;  
- в `WORKLOG.md` зафиксированы шаги, согласованные на уровне автономности.

## 5) Пороговые триггеры согласования (см. `.memory/AUTONOMY.md`)
- Изменение **публичного контракта** (OpenAPI/JSON Schema), bump MAJOR/MINOR;  
- Добавление новой внешней зависимости/инфры/пермишенов/секретов;  
- Дельта **LOC > 150** или **files_changed > 5** в одной задаче;  
- Смена асимптотики/режима хранения; добавление внешнего сетевого вызова;  
- Изменения, затрагивающие безопасность/лицензии/конфиденциальность.

## 6) Финальный ответ
- Верни **текстовый отчёт** по `.memory/REPORT_TEMPLATE.md`.  
- Приложи **`REPORT.json`**, валидный по `.memory/REPORT_SCHEMA.json`.  
- Укажи: key decisions, прочие шаги, архитектурные изменения, изменения по файлам, риски, синхронизацию артефактов.

## 7) Политика PR
Один PR — одна цель. Перед PR:
- пройди pre-commit чек-лист (см. `.memory/CONTEXT.md`),  
- проверь SemVer/Deprecation,  
- синхронизируй ADR/PROGRESS/TASKS/INDEX.

## 8) Антипаттерны (запрещено)
- Менять публичные контракты без `contracts/*` и VERSION bump.  
- Обходить LOCK и писать напрямую в TASKS/PROGRESS/ADR.  
- Вносить «временные» костыли без ADR/срока удаления.  
- Коммитить секреты/ключи; нарушать лицензионные условия.

## 9) Доказательства
К отчёту приложи: команды запуска тестов/линта и краткие логи/снимки версий контрактов.
